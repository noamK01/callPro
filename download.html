<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download CallAgent V5.0 (Make + Zapier)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #f0f9ff; margin: 0; }
        button { padding: 20px 40px; font-size: 20px; background: #6366f1; color: white; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); margin-top: 20px; }
        button:hover { background: #4f46e5; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
        h1 { color: #0f172a; margin-bottom: 10px; }
        p { color: #64748b; margin: 5px 0; text-align: center; max-width: 600px; }
        .tag { background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-top: 10px; display: inline-block; }
    </style>
</head>
<body>
    <h1>CallAgent Pro - 专住 V5.0</h1>
    <div class="tag">Make.com + Zapier Integration</div>
    <p>1. 转 驻: 砖 -Make -Zapier 拽.</p>
    <p>2. JSON 砖 转 砖转 驻驻专转.</p>
    <p>3. 住 专转 注 注 驻砖专转  -Webhooks.</p>
    <button onclick="downloadZip()"> 专 驻专拽 (ZIP)</button>

    <script>
        async function downloadZip() {
            const zip = new JSZip();

            // 1. Root Configuration
            zip.file("package.json", `{
  "name": "call-agent-pro",
  "private": true,
  "version": "5.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "lucide-react": "^0.344.0",
    "recharts": "^2.12.2"
  },
  "devDependencies": {
    "@types/react": "^18.2.64",
    "@types/react-dom": "^18.2.21",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.18",
    "postcss": "^8.4.35",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.2.2",
    "vite": "^5.1.6"
  }
}`);

            zip.file("vercel.json", `{
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}`);

            zip.file("vite.config.ts", `import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
})`);

            zip.file("tsconfig.json", `{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["**/*.ts", "**/*.tsx"]
}`);

            // 2. HTML Entry
            zip.file("index.html", `<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="https://lucide.dev/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CallAgent Pro V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Rubik', 'sans-serif'],
            },
            colors: {
              slate: {
                850: '#151e2e',
                900: '#0f172a',
              },
              primary: {
                50: '#f5f3ff',
                100: '#ede9fe',
                500: '#8b5cf6',
                600: '#7c3aed',
                700: '#6d28d9',
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out',
              'slide-up': 'slideUp 0.5s ease-out',
            },
            keyframes: {
              fadeIn: {
                '0%': { opacity: '0' },
                '100%': { opacity: '1' },
              },
              slideUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          },
        },
      }
    </script>
    <style>
      body { font-family: 'Rubik', sans-serif; background-color: #f8fafc; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/index.tsx"><\/script>
  </body>
</html>`);

            // 3. React Entry & Types
            zip.file("index.tsx", `import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);`);

            zip.file("types.ts", `export type RejectionReason = 'no_credit' | 'no_money' | 'not_interested' | 'other';

export interface CallReport {
  id: string;
  agent_name?: string;
  donation_closed: boolean;
  rejection_reason: RejectionReason | null;
  timestamp: string;
}

export interface AppSettings {
  zapierWebhookUrl: string;
  makeWebhookUrl: string;
  agentName: string;
  dailyReportTime: string; // Format "HH:MM"
}

export interface ChartData {
  name: string;
  value: number;
  fill: string;
  [key: string]: any;
}

export interface DailyStats {
  total: number;
  closedRate: string;
  chartData: ChartData[];
  mainDifficulty: string;
  failedTotal: number;
  closedTotal: number;
  rejectionCounts: Record<RejectionReason, number>;
}

export const REJECTION_LABELS: Record<RejectionReason, string> = {
  no_credit: ' 砖专',
  no_money: '  住祝',
  not_interested: ' 注',
  other: '专'
};`);

            // 4. Main App Logic (Updated to use integrationService and pass Make URL)
            zip.file("App.tsx", `import React, { useState, useEffect } from 'react';
import { Phone, Settings as SettingsIcon, Menu, X, LayoutDashboard, Clock } from 'lucide-react';
import { ReportForm } from './components/ReportForm';
import { Dashboard } from './components/Dashboard';
import { Settings } from './components/Settings';
import { storageService } from './services/storageService';
import { sendToIntegrations } from './services/integrationService';
import { calculateDailyStats } from './services/statsService';
import { CallReport } from './types';

type View = 'report' | 'stats' | 'settings';

function App() {
  const [currentView, setCurrentView] = useState<View>('report');
  const [reports, setReports] = useState<CallReport[]>([]);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [autoReportStatus, setAutoReportStatus] = useState<string | null>(null);

  useEffect(() => {
    loadData();
    const timer = setInterval(() => {
      checkAndSendDailyReport();
    }, 60000); 
    return () => clearInterval(timer);
  }, []);

  const loadData = () => {
    setReports(storageService.getReports());
  };

  const checkAndSendDailyReport = async () => {
    const settings = storageService.getSettings();
    if ((!settings.zapierWebhookUrl && !settings.makeWebhookUrl) || !settings.dailyReportTime) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
    const todayDateStr = now.toDateString();
    const lastReportDate = storageService.getLastDailyReportDate();

    if (currentTime === settings.dailyReportTime && lastReportDate !== todayDateStr) {
       const currentReports = storageService.getReports();
       const stats = calculateDailyStats(currentReports);
       
       if (stats && stats.total > 0) {
         try {
           const dailySummary = {
             type: 'daily_summary',
             agent_name: settings.agentName || ' 专',
             date: now.toLocaleDateString('he-IL'),
             total_calls: stats.total,
             total_sales: stats.closedTotal,
             failed_total: stats.failedTotal,
             conversion_rate: \`\${stats.closedRate}%\`,
             top_rejection_reason: stats.mainDifficulty,
             count_no_credit: stats.rejectionCounts.no_credit,
             count_no_money: stats.rejectionCounts.no_money,
             count_not_interested: stats.rejectionCounts.not_interested,
             count_other: stats.rejectionCounts.other,
             auto_generated: true
           };

           await sendToIntegrations({
             zapierUrl: settings.zapierWebhookUrl,
             makeUrl: settings.makeWebhookUrl
           }, dailySummary);

           storageService.setLastDailyReportDate(todayDateStr);
           setAutoReportStatus(\`  砖 转 -\${currentTime}\`);
           setTimeout(() => setAutoReportStatus(null), 5000);
           
         } catch (e) {
           console.error('Auto report failed', e);
         }
       }
    }
  };

  const navItems = [
    { id: 'report', label: ' 砖', icon: Phone },
    { id: 'stats', label: '砖专', icon: LayoutDashboard },
    { id: 'settings', label: '专转', icon: SettingsIcon },
  ];

  const NavContent = () => (
    <>
      <div className="flex items-center space-x-3 space-x-reverse px-4 mb-10">
        <div className="w-10 h-10 bg-gradient-to-br from-primary-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary-900/50">
           <Phone className="text-white w-5 h-5" />
        </div>
        <div>
          <h1 className="text-lg font-bold text-white tracking-wide">CallAgent</h1>
          <p className="text-xs text-slate-400 font-medium">v5.0 (Make+Zapier)</p>
        </div>
      </div>
      <nav className="space-y-2 px-2">
        {navItems.map((item) => {
          const Icon = item.icon;
          const isActive = currentView === item.id;
          return (
            <button
              key={item.id}
              onClick={() => {
                setCurrentView(item.id as View);
                setMobileMenuOpen(false);
              }}
              className={\`group w-full flex items-center space-x-3 space-x-reverse px-4 py-3.5 rounded-xl transition-all duration-200 \${
                isActive 
                  ? 'bg-gradient-to-r from-primary-600 to-indigo-600 text-white shadow-md shadow-primary-900/20' 
                  : 'text-slate-400 hover:bg-slate-800 hover:text-white'
              }\`}
            >
              <Icon className={\`w-5 h-5 transition-colors \${isActive ? 'text-white' : 'text-slate-500 group-hover:text-white'}\`} />
              <span className="font-medium">{item.label}</span>
            </button>
          );
        })}
      </nav>
    </>
  );

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans">
      {autoReportStatus && (
        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] bg-emerald-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center animate-slide-up">
           <Clock className="w-4 h-4 ml-2" />
           <span className="font-medium text-sm">{autoReportStatus}</span>
        </div>
      )}
      <aside className="hidden md:flex flex-col w-72 bg-slate-900 h-screen fixed right-0 top-0 p-6 z-50 shadow-2xl">
        <NavContent />
        <div className="mt-auto pt-6 border-t border-slate-800">
          <div className="bg-slate-800/50 rounded-xl p-4">
             <div className="flex items-center justify-between mb-2">
                <span className="text-xs font-bold text-slate-300">注 </span>
                <span className="text-xs text-primary-400">85%</span>
             </div>
             <div className="w-full bg-slate-700 rounded-full h-1.5">
               <div className="bg-primary-500 h-1.5 rounded-full w-[85%]"></div>
             </div>
          </div>
        </div>
      </aside>
      <div className="md:hidden fixed top-0 w-full bg-slate-900 z-40 px-4 py-3 flex items-center justify-between shadow-md">
        <div className="flex items-center space-x-3 space-x-reverse">
          <div className="w-8 h-8 bg-gradient-to-br from-primary-500 to-indigo-600 rounded-lg flex items-center justify-center">
             <Phone className="text-white w-4 h-4" />
          </div>
          <span className="font-bold text-white text-lg">CallAgent</span>
        </div>
        <button 
          onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
          className="p-2 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors"
        >
          {mobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
        </button>
      </div>
      {mobileMenuOpen && (
        <div className="md:hidden fixed inset-0 bg-black/60 z-50 backdrop-blur-sm" onClick={() => setMobileMenuOpen(false)}>
           <div className="bg-slate-900 w-72 h-full p-6 shadow-2xl animate-slide-up" onClick={e => e.stopPropagation()}>
              <NavContent />
           </div>
        </div>
      )}
      <main className="flex-1 md:mr-72 p-4 md:p-10 pt-20 md:pt-10 overflow-y-auto">
        <div className="max-w-6xl mx-auto">
          <header className="mb-10 flex flex-col md:flex-row md:items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-slate-800">
                {navItems.find(i => i.id === currentView)?.label}
              </h1>
              <p className="text-slate-500 mt-1 text-lg">
                {currentView === 'report' && ' 转 驻专 砖 专'}
                {currentView === 'stats' && '住拽专 转 砖 爪注'}
                {currentView === 'settings' && '专转 注专转 (Make & Zapier)'}
              </p>
            </div>
            <div className="hidden md:flex items-center bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 text-slate-600 text-sm font-medium">
               <span>{new Date().toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
            </div>
          </header>
          <div className="animate-fade-in">
            {currentView === 'report' && (
              <ReportForm onSave={loadData} />
            )}
            {currentView === 'stats' && (
              <Dashboard reports={reports} onReset={loadData} />
            )}
            {currentView === 'settings' && (
              <Settings />
            )}
          </div>
        </div>
      </main>
    </div>
  );
}

export default App;`);

            // 5. Components & Services
            const components = zip.folder("components");
            const ui = components.folder("ui");
            const services = zip.folder("services");

            // UI Card
            ui.file("Card.tsx", `import React from 'react';

interface CardProps {
  children: React.ReactNode;
  className?: string;
  title?: string;
  icon?: React.ReactNode;
}

export const Card: React.FC<CardProps> = ({ children, className = '', title, icon }) => {
  return (
    <div className={\`bg-white rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-slate-100 overflow-hidden transition-all duration-300 hover:shadow-[0_8px_30px_rgb(0,0,0,0.08)] \${className}\`}>
      {title && (
        <div className="px-6 py-5 border-b border-slate-50 flex items-center space-x-3 space-x-reverse">
          {icon && <div className="text-primary-500">{icon}</div>}
          <h3 className="text-lg font-bold text-slate-800">{title}</h3>
        </div>
      )}
      <div className="p-6">
        {children}
      </div>
    </div>
  );
};`);

            // Report Form (Updated to use integrationService)
            components.file("ReportForm.tsx", `import React, { useState } from 'react';
import { Save, AlertCircle, Check, X, PhoneCall, HelpCircle, ArrowRight } from 'lucide-react';
import { Card } from './ui/Card';
import { storageService } from '../services/storageService';
import { sendToIntegrations } from '../services/integrationService';
import { CallReport, RejectionReason, REJECTION_LABELS } from '../types';

interface ReportFormProps {
  onSave: () => void;
}

export const ReportForm: React.FC<ReportFormProps> = ({ onSave }) => {
  const [loading, setLoading] = useState(false);
  const [donationClosed, setDonationClosed] = useState<boolean | null>(null);
  const [selectedReason, setSelectedReason] = useState<RejectionReason | null>(null);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  const isFormValid = () => {
    if (donationClosed === null) return false;
    if (donationClosed === false && !selectedReason) return false;
    return true;
  };

  const getButtonText = () => {
    if (loading) return '注 转...';
    if (donationClosed === null) return ' 专 住住 砖';
    if (donationClosed === false && !selectedReason) return ' 专 住转 住专';
    return '砖专 ';
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isFormValid()) return;

    setLoading(true);
    setMessage(null);

    const settings = storageService.getSettings();

    const newReport: CallReport = {
      id: crypto.randomUUID(),
      agent_name: settings.agentName || ' 专',
      donation_closed: donationClosed!,
      rejection_reason: donationClosed ? null : selectedReason,
      timestamp: new Date().toISOString().replace('T', ' ').substring(0, 16),
    };

    try {
      storageService.saveReport(newReport);
      
      if (settings.zapierWebhookUrl || settings.makeWebhookUrl) {
        const { id, ...reportData } = newReport;
        await sendToIntegrations(
            { zapierUrl: settings.zapierWebhookUrl, makeUrl: settings.makeWebhookUrl },
            { type: 'single_call', ...reportData }
        );
      }

      setMessage({ type: 'success', text: ' 拽 爪!' });
      
      setTimeout(() => {
        setDonationClosed(null);
        setSelectedReason(null);
        setMessage(null);
        onSave();
      }, 1500);

    } catch (error) {
      setMessage({ type: 'error', text: '专注 砖 砖专转 转.' });
    } finally {
      setLoading(false);
    }
  };

  const reasons: RejectionReason[] = ['no_credit', 'no_money', 'not_interested', 'other'];

  return (
    <div className="max-w-3xl mx-auto animate-slide-up">
      <Card title=" 砖" icon={<PhoneCall className="w-5 h-5" />}>
        <form onSubmit={handleSubmit} className="space-y-8">
          
          {/* Donation Status Toggle */}
          <div>
            <label className="block text-sm font-semibold text-slate-500 mb-4 uppercase tracking-wider">住住 砖</label>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              <button
                type="button"
                onClick={() => {
                  setDonationClosed(true);
                  setSelectedReason(null);
                  setMessage(null);
                }}
                className={\`group relative overflow-hidden flex flex-col items-center justify-center p-8 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm \${
                  donationClosed === true
                    ? 'bg-gradient-to-br from-emerald-400 to-emerald-600 text-white shadow-lg shadow-emerald-200 ring-4 ring-emerald-100'
                    : 'bg-white border-2 border-slate-100 text-slate-400 hover:border-emerald-200 hover:bg-emerald-50'
                }\`}
              >
                <div className={\`w-14 h-14 rounded-full flex items-center justify-center mb-4 transition-colors \${
                  donationClosed === true ? 'bg-white/20' : 'bg-slate-100 group-hover:bg-emerald-100'
                }\`}>
                  <Check className={\`w-7 h-7 \${donationClosed === true ? 'text-white' : 'text-slate-400 group-hover:text-emerald-500'}\`} />
                </div>
                <span className="font-bold text-xl">转专 住专!</span>
                <span className={\`text-sm mt-1 \${donationClosed === true ? 'text-emerald-100' : 'text-slate-400'}\`}>爪</span>
                
                {donationClosed === true && (
                   <div className="absolute inset-0 border-4 border-white/20 rounded-2xl animate-pulse"></div>
                )}
              </button>

              <button
                type="button"
                onClick={() => {
                  setDonationClosed(false);
                  setMessage(null);
                }}
                className={\`group relative overflow-hidden flex flex-col items-center justify-center p-8 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] shadow-sm \${
                  donationClosed === false
                    ? 'bg-gradient-to-br from-rose-400 to-rose-600 text-white shadow-lg shadow-rose-200 ring-4 ring-rose-100'
                    : 'bg-white border-2 border-slate-100 text-slate-400 hover:border-rose-200 hover:bg-rose-50'
                }\`}
              >
                <div className={\`w-14 h-14 rounded-full flex items-center justify-center mb-4 transition-colors \${
                   donationClosed === false ? 'bg-white/20' : 'bg-slate-100 group-hover:bg-rose-100'
                }\`}>
                  <X className={\`w-7 h-7 \${donationClosed === false ? 'text-white' : 'text-slate-400 group-hover:text-rose-500'}\`} />
                </div>
                <span className="font-bold text-xl"> 住专</span>
                <span className={\`text-sm mt-1 \${donationClosed === false ? 'text-rose-100' : 'text-slate-400'}\`}>驻住驻住</span>
              </button>
            </div>
          </div>

          {/* Rejection Reasons Grid */}
          <div className={\`transition-all duration-500 ease-in-out overflow-hidden \${donationClosed === false ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}\`}>
            <label className="block text-sm font-semibold text-slate-500 mb-4 uppercase tracking-wider flex items-center">
              <HelpCircle className="w-4 h-4 ml-1" />
              住转 -住专
            </label>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {reasons.map((reason) => (
                <button
                  key={reason}
                  type="button"
                  onClick={() => setSelectedReason(reason)}
                  className={\`relative py-4 px-2 rounded-xl font-medium text-sm transition-all duration-200 flex flex-col items-center justify-center gap-2 \${
                    selectedReason === reason
                      ? 'bg-slate-800 text-white shadow-lg shadow-slate-200 scale-105 ring-2 ring-slate-400'
                      : 'bg-slate-50 text-slate-600 hover:bg-white hover:shadow-md border border-transparent hover:border-slate-200'
                  }\`}
                >
                  <span className={\`w-2 h-2 rounded-full \${selectedReason === reason ? 'bg-rose-400' : 'bg-slate-300'}\`}></span>
                  {REJECTION_LABELS[reason]}
                </button>
              ))}
            </div>
          </div>

          {message && (
            <div className={\`p-4 rounded-xl flex items-center animate-fade-in \${message.type === 'success' ? 'bg-emerald-50 text-emerald-700 border border-emerald-100' : 'bg-rose-50 text-rose-700 border border-rose-100'}\`}>
              {message.type === 'success' ? <Check className="w-5 h-5 ml-2" /> : <AlertCircle className="w-5 h-5 ml-2" />}
              <span className="font-medium">{message.text}</span>
            </div>
          )}

          <div className="pt-2">
            <button
              type="submit"
              disabled={!isFormValid() || loading}
              className={\`
                w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all duration-300 transform flex items-center justify-center
                \${!isFormValid() || loading
                  ? 'bg-slate-100 text-slate-400 cursor-not-allowed shadow-none' 
                  : 'bg-gradient-to-r from-primary-600 to-indigo-600 text-white hover:from-primary-500 hover:to-indigo-500 hover:scale-[1.01] hover:shadow-primary-200'}
              \`}
            >
              {loading && <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-3" />}
              {getButtonText()}
              {isFormValid() && !loading && <ArrowRight className="w-5 h-5 mr-2 opacity-80" />}
            </button>
          </div>
        </form>
      </Card>
    </div>
  );
};`);

            // Dashboard (Updated to use integrationService)
            components.file("Dashboard.tsx", `import React, { useMemo, useState } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
import { TrendingUp, AlertTriangle, CheckCircle, PieChart as PieChartIcon, Activity, Send, Trash2 } from 'lucide-react';
import { Card } from './ui/Card';
import { storageService } from '../services/storageService';
import { sendToIntegrations } from '../services/integrationService';
import { CallReport } from '../types';
import { calculateDailyStats } from '../services/statsService';

interface DashboardProps {
  reports: CallReport[];
  onReset: () => void;
}

const COLORS = ['#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'];

export const Dashboard: React.FC<DashboardProps> = ({ reports, onReset }) => {
  const [sendingReport, setSendingReport] = useState(false);
  const [reportSentMsg, setReportSentMsg] = useState('');

  const stats = useMemo(() => {
    const data = calculateDailyStats(reports);
    if (data) {
        data.chartData = data.chartData.map((item, index) => ({
            ...item,
            fill: COLORS[index % COLORS.length]
        }));
    }
    return data;
  }, [reports]);

  const handleSendDailyReport = async () => {
    if (!stats) return;
    
    setSendingReport(true);
    const settings = storageService.getSettings();

    if (!settings.zapierWebhookUrl && !settings.makeWebhookUrl) {
      alert(' 专 转转 Zapier  Make 专转');
      setSendingReport(false);
      return;
    }

    const dailySummary = {
        type: 'daily_summary',
        agent_name: settings.agentName || ' 专',
        date: new Date().toLocaleDateString('he-IL'),
        total_calls: stats.total,
        total_sales: stats.closedTotal,
        failed_total: stats.failedTotal,
        conversion_rate: \`\${stats.closedRate}%\`,
        top_rejection_reason: stats.mainDifficulty,
        count_no_credit: stats.rejectionCounts.no_credit,
        count_no_money: stats.rejectionCounts.no_money,
        count_not_interested: stats.rejectionCounts.not_interested,
        count_other: stats.rejectionCounts.other
    };

    try {
        await sendToIntegrations({
            zapierUrl: settings.zapierWebhookUrl,
            makeUrl: settings.makeWebhookUrl
        }, dailySummary);
        
        setReportSentMsg(' 砖 爪!');
        storageService.setLastDailyReportDate(new Date().toDateString());
        setTimeout(() => setReportSentMsg(''), 4000);
    } catch (e) {
        alert('砖 砖转 ');
    } finally {
        setSendingReport(false);
    }
  };

  const handleResetData = () => {
      if (window.confirm(' 转  砖专爪 驻住 转  转 砖 ? 驻注   驻 转  砖.')) {
          storageService.clearReports();
          onReset();
          window.location.reload(); 
      }
  };

  if (!stats) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[400px] text-slate-400 bg-white rounded-3xl border border-slate-100 shadow-sm animate-fade-in">
        <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-6">
          <Activity className="w-10 h-10 text-slate-300" />
        </div>
        <h3 className="text-xl font-bold text-slate-600 mb-2"> 转 爪</h3>
        <p className="text-sm">转  注 砖转 转 驻注  驻 </p>
      </div>
    );
  }

  return (
    <div className="space-y-8 animate-slide-up">
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="relative overflow-hidden bg-gradient-to-br from-violet-600 to-indigo-700 text-white rounded-2xl p-6 shadow-xl shadow-indigo-200">
          <div className="absolute top-0 right-0 p-4 opacity-10">
            <CheckCircle className="w-24 h-24 transform translate-x-4 -translate-y-4" />
          </div>
          <p className="text-indigo-100 text-sm font-medium mb-1"> 住专</p>
          <div className="flex items-baseline">
            <h2 className="text-4xl font-bold">{stats.closedRate}%</h2>
            <span className="text-sm text-indigo-200 mr-2">爪</span>
          </div>
          <div className="mt-4 w-full bg-white/20 rounded-full h-1.5">
            <div 
              className="bg-white h-1.5 rounded-full transition-all duration-1000" 
              style={{ width: \`\${stats.closedRate}%\` }}
            ></div>
          </div>
        </div>

        <div className="relative overflow-hidden bg-gradient-to-br from-rose-500 to-orange-600 text-white rounded-2xl p-6 shadow-xl shadow-rose-200">
           <div className="absolute top-0 right-0 p-4 opacity-10">
            <AlertTriangle className="w-24 h-24 transform translate-x-4 -translate-y-4" />
          </div>
          <p className="text-rose-100 text-sm font-medium mb-1">住专 驻抓</p>
          <h2 className="text-3xl font-bold truncate mt-1">{stats.mainDifficulty}</h2>
          <p className="text-xs text-rose-100 mt-2 opacity-80">专砖 转砖转  砖驻专</p>
        </div>

        <div className="relative overflow-hidden bg-white border border-slate-100 text-slate-800 rounded-2xl p-6 shadow-lg shadow-slate-100">
          <div className="absolute top-0 right-0 p-4 opacity-5">
            <TrendingUp className="w-24 h-24 transform translate-x-4 -translate-y-4" />
          </div>
          <p className="text-slate-500 text-sm font-medium mb-1">住" 砖转 </p>
          <h2 className="text-4xl font-bold text-slate-800">{stats.total}</h2>
          <div className="flex space-x-3 space-x-reverse mt-4 text-sm">
             <span className="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-md font-medium">{stats.closedTotal} 住专转</span>
             <span className="text-rose-600 bg-rose-50 px-2 py-0.5 rounded-md font-medium">{stats.failedTotal} 住专</span>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <Card title="转驻转 住转 住专" icon={<PieChartIcon className="w-5 h-5"/>} className="lg:col-span-2 min-h-[450px]">
          {stats.chartData.length > 0 ? (
            <div className="h-80 w-full relative" dir="ltr">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={stats.chartData}
                    cx="50%"
                    cy="50%"
                    innerRadius={80}
                    outerRadius={110}
                    paddingAngle={4}
                    dataKey="value"
                    stroke="none"
                  >
                    {stats.chartData.map((entry, index) => (
                      <Cell key={\`cell-\${index}\`} fill={entry.fill || COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip 
                    contentStyle={{ 
                      borderRadius: '12px', 
                      border: 'none', 
                      boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                      padding: '12px'
                    }}
                    itemStyle={{ color: '#1e293b', fontWeight: 600 }}
                  />
                  <Legend 
                    verticalAlign="bottom" 
                    height={36} 
                    iconType="circle"
                    formatter={(value) => <span className="text-slate-600 font-medium ml-2">{value}</span>}
                  />
                </PieChart>
              </ResponsiveContainer>
              <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none pb-8">
                <span className="text-3xl font-bold text-slate-800">{stats.failedTotal}</span>
                <span className="text-xs text-slate-400 font-medium uppercase tracking-wider">住专</span>
              </div>
            </div>
          ) : (
             <div className="h-80 flex flex-col items-center justify-center text-slate-400">
               <CheckCircle className="w-16 h-16 mb-4 text-emerald-100" />
               <p className="text-lg font-medium text-emerald-600"> 住专 爪</p>
               <p className="text-sm">爪注 砖!</p>
             </div>
          )}
        </Card>

        <div className="space-y-6">
           <Card title=" 住祝 " className="bg-gradient-to-br from-slate-800 to-slate-900 text-white border-none shadow-2xl">
              <p className="text-slate-300 text-sm mb-6 leading-relaxed">
                    专 砖 转 砖注 砖专 专转. 转  砖 转 注转.
              </p>
              
              <button
                onClick={handleSendDailyReport}
                disabled={sendingReport}
                className="w-full flex items-center justify-center px-4 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-xl transition-all duration-200 shadow-lg shadow-primary-900/50"
              >
                {sendingReport ? (
                    <span className="flex items-center"><Activity className="animate-spin w-4 h-4 ml-2"/> 砖...</span>
                ) : (
                    <span className="flex items-center font-bold"><Send className="w-4 h-4 ml-2"/> 砖 注砖 转</span>
                )}
              </button>
              {reportSentMsg && (
                  <p className="text-emerald-400 text-xs text-center mt-3 animate-fade-in font-bold">{reportSentMsg}</p>
              )}
           </Card>

           <Card title="专 ">
              <div className="flex flex-col h-full justify-between">
                <div>
                  <p className="text-slate-600 mb-6 leading-relaxed text-sm">
                    住  注? 拽 转 转 拽  转 专 祝 砖 拽.
                  </p>
                  
                  <button
                    onClick={handleResetData}
                    className="w-full flex items-center justify-center px-4 py-3 bg-rose-50 text-rose-600 hover:bg-rose-100 rounded-xl transition-all duration-200 border border-rose-100"
                  >
                    <Trash2 className="w-4 h-4 ml-2" />
                    <span className="font-bold">拽转 转 专注</span>
                  </button>
                </div>
              </div>
            </Card>
        </div>
      </div>
    </div>
  );
};`);

            // Settings (Added Make Input)
            components.file("Settings.tsx", `import React, { useState, useEffect } from 'react';
import { Card } from './ui/Card';
import { storageService } from '../services/storageService';
import { sendToIntegrations } from '../services/integrationService';
import { Save, Webhook, User, Clock, Activity, CheckCircle, AlertCircle } from 'lucide-react';

export const Settings: React.FC = () => {
  const [zapierUrl, setZapierUrl] = useState('');
  const [makeUrl, setMakeUrl] = useState('');
  const [agentName, setAgentName] = useState('');
  const [dailyReportTime, setDailyReportTime] = useState('17:00');
  const [saved, setSaved] = useState(false);
  const [testing, setTesting] = useState(false);
  const [testStatus, setTestStatus] = useState<'idle' | 'success' | 'error'>('idle');

  useEffect(() => {
    const settings = storageService.getSettings();
    if (settings.zapierWebhookUrl) setZapierUrl(settings.zapierWebhookUrl);
    if (settings.makeWebhookUrl) setMakeUrl(settings.makeWebhookUrl);
    if (settings.agentName) setAgentName(settings.agentName);
    if (settings.dailyReportTime) setDailyReportTime(settings.dailyReportTime);
  }, []);

  const handleSave = (e: React.FormEvent) => {
    e.preventDefault();
    storageService.saveSettings({ 
      zapierWebhookUrl: zapierUrl,
      makeWebhookUrl: makeUrl,
      agentName: agentName,
      dailyReportTime: dailyReportTime
    });
    setSaved(true);
    setTimeout(() => setSaved(false), 3000);
  };

  const handleTestConnection = async () => {
    if (!zapierUrl && !makeUrl) return;
    setTesting(true);
    setTestStatus('idle');
    try {
        await sendToIntegrations({ zapierUrl, makeUrl }, {
            type: 'test_connection',
            message: '拽转 转拽砖专转 爪转 注专转 - CallAgent Pro',
            agent_name: agentName || '爪 拽', 
            timestamp: new Date().toISOString(),
            total_calls: 0,
            total_sales: 0,
            failed_total: 0,
            conversion_rate: '0%',
            top_rejection_reason: '拽',
            count_no_credit: 0,
            count_no_money: 0,
            count_not_interested: 0,
            count_other: 0
        });
        setTestStatus('success');
        setTimeout(() => setTestStatus('idle'), 4000);
    } catch (e) {
        setTestStatus('error');
    } finally {
        setTesting(false);
    }
  };

  return (
    <div className="max-w-2xl mx-auto animate-slide-up">
      <Card title="专转 注专转">
        <form onSubmit={handleSave} className="space-y-8">
          <div className="border-b border-slate-100 pb-6">
             <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">驻专 爪</h3>
             <div className="space-y-4">
               <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2 flex items-center">
                    <User className="w-4 h-4 ml-2 text-primary-500" />
                    砖 爪
                  </label>
                  <input
                    type="text"
                    value={agentName}
                    onChange={(e) => setAgentName(e.target.value)}
                    placeholder=": 住 "
                    className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all"
                  />
               </div>
             </div>
          </div>
          <div className="border-b border-slate-100 pb-6">
             <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">爪</h3>
             <div>
                <label className="block text-sm font-medium text-slate-700 mb-2 flex items-center">
                  <Clock className="w-4 h-4 ml-2 text-primary-500" />
                  砖注转   
                </label>
                <input
                  type="time"
                  value={dailyReportTime}
                  onChange={(e) => setDailyReportTime(e.target.value)}
                  className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all text-left dir-ltr"
                />
             </div>
          </div>
          <div>
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">专爪转</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2 flex items-center">
                  <Webhook className="w-4 h-4 ml-2 text-orange-500" />
                  转转 Webhook 砖 Zapier
                </label>
                <input
                  type="url"
                  value={zapierUrl}
                  onChange={(e) => setZapierUrl(e.target.value)}
                  placeholder="https://hooks.zapier.com/..."
                  className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none dir-ltr text-left"
                  dir="ltr"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2 flex items-center">
                  <Webhook className="w-4 h-4 ml-2 text-purple-600" />
                  转转 Webhook 砖 Make.com (Integromat)
                </label>
                <input
                  type="url"
                  value={makeUrl}
                  onChange={(e) => setMakeUrl(e.target.value)}
                  placeholder="https://hook.make.com/..."
                  className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-purple-600 focus:border-transparent outline-none dir-ltr text-left"
                  dir="ltr"
                />
              </div>

              <div className="flex items-center justify-between mt-3 pt-2">
                  <div className="flex items-center">
                    {testStatus === 'success' && <span className="text-xs text-emerald-600 ml-3 flex items-center font-bold animate-fade-in"><CheckCircle className="w-3 h-3 ml-1"/> 转拽!</span>}
                    {testStatus === 'error' && <span className="text-xs text-rose-600 ml-3 flex items-center font-bold animate-fade-in"><AlertCircle className="w-3 h-3 ml-1"/> 砖</span>}
                    <button
                        type="button"
                        onClick={handleTestConnection}
                        disabled={(!zapierUrl && !makeUrl) || testing}
                        className="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center"
                    >
                        {testing ? <Activity className="w-3 h-3 animate-spin"/> : '拽 专'}
                    </button>
                  </div>
              </div>
            </div>
          </div>
          <div className="flex justify-end pt-4">
            <button
              type="submit"
              className={\`flex items-center px-8 py-3 rounded-xl text-white font-medium transition-all transform hover:scale-105 shadow-lg \${saved ? 'bg-emerald-500 hover:bg-emerald-600 shadow-emerald-200' : 'bg-primary-600 hover:bg-primary-700 shadow-primary-200'}\`}
            >
              <Save className="w-4 h-4 ml-2" />
              {saved ? '专转 砖专!' : '砖专 专转'}
            </button>
          </div>
        </form>
      </Card>
    </div>
  );
};`);

            // Services
            services.file("storageService.ts", `import { CallReport, AppSettings } from '../types';

const REPORTS_KEY = 'call_agent_reports';
const SETTINGS_KEY = 'call_agent_settings';
const LAST_REPORT_DATE_KEY = 'call_agent_last_daily_report';

export const storageService = {
  getReports: (): CallReport[] => {
    try {
      const data = localStorage.getItem(REPORTS_KEY);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      console.error('Failed to parse reports', e);
      return [];
    }
  },

  saveReport: (report: CallReport): CallReport[] => {
    const current = storageService.getReports();
    const updated = [...current, report];
    localStorage.setItem(REPORTS_KEY, JSON.stringify(updated));
    return updated;
  },

  clearReports: (): void => {
    localStorage.removeItem(REPORTS_KEY);
  },

  getSettings: (): AppSettings => {
    try {
      const data = localStorage.getItem(SETTINGS_KEY);
      const parsed = data ? JSON.parse(data) : {};
      return {
        zapierWebhookUrl: parsed.zapierWebhookUrl || '',
        makeWebhookUrl: parsed.makeWebhookUrl || '',
        agentName: parsed.agentName || '',
        dailyReportTime: parsed.dailyReportTime || '17:00'
      };
    } catch (e) {
      return { zapierWebhookUrl: '', makeWebhookUrl: '', agentName: '', dailyReportTime: '17:00' };
    }
  },

  saveSettings: (settings: AppSettings): void => {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  },

  getLastDailyReportDate: (): string | null => {
    return localStorage.getItem(LAST_REPORT_DATE_KEY);
  },

  setLastDailyReportDate: (dateStr: string): void => {
    localStorage.setItem(LAST_REPORT_DATE_KEY, dateStr);
  }
};`);

            // NEW: Integration Service (Replaces zapierService)
            services.file("integrationService.ts", `
export const sendToIntegrations = async (urls: { zapierUrl?: string; makeUrl?: string }, data: Record<string, any>) => {
  const promises = [];

  if (urls.zapierUrl) {
    promises.push(
      fetch(urls.zapierUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      }).catch(err => console.error("Zapier Error:", err))
    );
  }

  if (urls.makeUrl) {
    promises.push(
      fetch(urls.makeUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      }).catch(err => console.error("Make Error:", err))
    );
  }

  await Promise.all(promises);
};`);

            services.file("statsService.ts", `import { CallReport, DailyStats, REJECTION_LABELS, RejectionReason } from '../types';

const REJECTION_KEYS: RejectionReason[] = ['no_credit', 'no_money', 'not_interested', 'other'];

export const calculateDailyStats = (reports: CallReport[]): DailyStats | null => {
  if (reports.length === 0) return null;

  const total = reports.length;
  const closed = reports.filter(r => r.donation_closed).length;
  const closedRate = total > 0 ? ((closed / total) * 100).toFixed(0) : '0';

  const failedReports = reports.filter(r => !r.donation_closed && r.rejection_reason);
  
  const counts: Record<RejectionReason, number> = {
    no_credit: 0,
    no_money: 0,
    not_interested: 0,
    other: 0
  };

  failedReports.forEach(r => {
    if (r.rejection_reason && counts[r.rejection_reason] !== undefined) {
      counts[r.rejection_reason]++;
    }
  });

  const chartData = REJECTION_KEYS.map(key => ({
    name: REJECTION_LABELS[key],
    value: counts[key],
    fill: '' // Will be assigned in component
  })).filter(item => item.value > 0);

  let mainDifficulty = ' 转';
  let maxCount = 0;

  Object.entries(counts).forEach(([key, count]) => {
    if (count > maxCount) {
      maxCount = count;
      mainDifficulty = REJECTION_LABELS[key as RejectionReason];
    }
  });

  return {
    total,
    closedRate,
    chartData,
    mainDifficulty,
    failedTotal: failedReports.length,
    closedTotal: closed,
    rejectionCounts: counts
  };
};`);

            // Generate ZIP
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "call-agent-pro-v5.0.zip";
            link.click();
        }
    </script>
</body>
</html>